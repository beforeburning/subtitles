"use strict";var ajax=function(t,e,n){var i="id="+t,a=new XMLHttpRequest;a.onreadystatechange=function(){4===a.readyState&&200===a.status&&n(a.response)},a.open("POST",e,!0),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.send(i)},DomClass=function(t){return document.getElementsByClassName(t)[0]},DomId=function(t){return document.getElementById(t)},conversion=function(t){var e=t.split(","),n=e[0].split(":");return parseFloat(60*parseInt(n[1])+parseInt(n[2])+"."+e[1])},audioTime=function(t){DomId("video").currentTime=conversion(t),DomId("video").play()},suspended=function(){return video.paused?DomId("video").play():DomId("video").pause()},completion=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"0";return 3===t.substring(0,3).length?t.substring(0,3):2===t.substring(0,3).length?t.substring(0,3)+"0":1===t.substring(0,3).length?t.substring(0,3)+"00":t},MillisecondToDate=function(t){var e=parseFloat(t)/1e3;if(e<=60){var n=e.toString().split(".");return"00:00:"+(n[0]<=9?"0"+n[0]:n[0])+","+completion(n[1])}var i=parseInt((e/60).toString().split(".")[0]),a=(e-60*i).toString().split(".");return"00:"+(i<=59?"0"+i:i)+":"+(a[0]<=9?"0"+a[0]:a[0])+","+completion(a[1])},newTime=function(t,e){return MillisecondToDate(t+e)};DomClass("loading").onclick=function(t){return t.target.style.display="none"};var set=[];window.onload=function(){!function(){var t=DomClass("table").dataset.id;if(!t)return alert("ID错误,请联系管理员查看"),!1;ajax(t,dataAjaxUrl,function(t){JSON.parse(t).data.forEach(function(t){var e=t.time.split("--\x3e"),n={start:e[0].replace(/\s+/g,""),end:e[1].replace(/\s+/g,""),text:t.text};set.push(n)}),drawing(),video.addEventListener("play",function(){highlighted()}),video.addEventListener("pause",function(){clearTimeout(window.timing)})})}()};var drawing=function(){var t="";set.forEach(function(e,n){var i="\n      <div class='line'>\n        <div class='serial'>"+ ++n+"</div>\n        <div class='start'>"+e.start+"</div>\n        <div class='end'>"+e.end+"</div>\n        <input class='text' data-id='"+n+"' type='text' value='"+e.text+"' />\n      </div>\n    ";t+=i}),DomClass("table").innerHTML=t,Listening(),video.paused&&(clearTimeout(window.timing),highlighted())},Listening=function(){var t=!0,e=!1,n=void 0;try{for(var i,a=DomClass("table").children[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var r=i.value;r.children[0].onclick=function(){return suspended()},r.children[1].onclick=function(t){return audioTime(t.target.innerHTML)},r.children[2].onclick=function(t){return audioTime(t.target.innerHTML)},r.children[3].onfocus=function(t){document.onkeydown=function(e){var n=e||window.event,i=t.target.value.length,a=n.target.selectionStart,r=n.target.selectionEnd,s=parseInt(t.target.dataset.id),o=t.target.value;if(n&&8===n.keyCode&&0===a&&s-1!=0&&(0===i||r-a!==i)){var d=t.path[1].previousElementSibling.children[3].value,l=set[s-1],u=set[s-2];return set[s-2]={start:u.start,end:l.end,text:""+d+o},set.splice(s-1,1),drawing(set),!1}if(n&&13===n.keyCode&&0!==i&&0!==a&&a!==i){var c=1e3*conversion(set[s-1].start),v=1e3*conversion(set[s-1].end),g=v-c,f=parseInt(a/i*g),m=newTime(c,f),p=t.target.value.substring(0,n.target.selectionStart),h=t.target.value.substring(n.target.selectionStart),w={start:m,end:set[s-1].end,text:h};return set[s-1]={start:set[s-1].start,end:m,text:p},set.splice(s,0,w),drawing(),!1}setTimeout(function(){set[s-1].text=t.target.value},100)}},r.children[3].onblur=function(){document.onkeydown=function(t){},dataSubmit()}}}catch(t){e=!0,n=t}finally{try{!t&&a.return&&a.return()}finally{if(e)throw n}}DomClass("loading").style.display="none"},dataSubmit=function(){if(set){console.log(set);var t={id:DomClass("table").dataset.id,data:set};DomId("btn").onclick=function(){return ajax(JSON.stringify(t),dataSubmitUrl,function(t){var e=JSON.parse(t);e.success?helpblock("提示：",e.message,"info"):helpblock("错误：",e.message,"error")})}}},highlighted=function(){var t=DomId("video"),e=set.map(function(t){return 1e3*conversion(t.start)}),n=DomClass("table").children;window.timing=window.setInterval(function(){var i=1e3*t.currentTime,a=0;e.map(function(t,e){t<i&&(a=e)});for(var r=0;r<n.length;r++)r===a?n[r].classList.add("highlighted"):n[r].classList.remove("highlighted")},500)};